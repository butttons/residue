---
import { Github } from "lucide-astro";
import Layout from "../layouts/Layout.astro";
---

<Layout
    title="Documentation - residue"
    description="Complete guide to using residue. Capture AI agent conversations and link them to git commits."
>
    <div class="max-w-5xl mx-auto px-6 py-20">
        <div class="mb-12">
            <h1 class="text-3xl font-bold mb-4">Documentation</h1>
            <p class="text-base text-zinc-400">
                Complete guide to setting up and using residue.
            </p>
        </div>

        <!-- Overview -->
        <div class="mb-16">
            <h2 class="text-2xl font-bold mb-6 text-amber-400">Overview</h2>
            <p class="text-zinc-300 text-sm leading-relaxed mb-4">
                Residue has two packages: a <strong>CLI</strong> that runs
                locally and a <strong>Cloudflare Worker</strong> that stores and
                serves data. Agent adapters are built into the CLI.
            </p>
            <p class="text-zinc-300 text-sm leading-relaxed">
                The CLI manages local state, installs git hooks, and handles
                syncing. Session data is uploaded directly to R2 via presigned
                URLs. The worker provides an API for metadata and presigned URL
                generation, plus a web UI for browsing conversations.
            </p>
        </div>

        <!-- Prerequisites -->
        <div class="mb-16">
            <h2 class="text-2xl font-bold mb-6 text-amber-400">Prerequisites</h2>
            <div class="bg-zinc-900/50 border border-zinc-800 rounded-lg p-6">
                <ul class="space-y-2 text-zinc-300 text-sm">
                    <li><strong><a href="https://bun.sh" target="_blank" rel="noopener noreferrer" class="text-amber-400 hover:underline">Bun</a></strong> (required runtime for the CLI)</li>
                    <li><strong>Git</strong> (hooks are installed in .git/hooks/)</li>
                    <li><strong>Cloudflare account</strong> (for deploying the worker)</li>
                    <li><strong>A supported AI agent:</strong> Claude Code or pi</li>
                </ul>
            </div>
        </div>

        <!-- Setup -->
        <div id="setup" class="mb-16">
            <h2 class="text-2xl font-bold mb-6 text-amber-400">Setup</h2>

            <p class="text-zinc-300 text-sm leading-relaxed mb-8">
                Six steps: create the R2 bucket with S3 API credentials, deploy the worker, set up AI Search, install the CLI, then configure your repos.
            </p>

            <!-- One-time setup label -->
            <div class="flex items-center gap-3 mb-8">
                <div class="h-px flex-1 bg-zinc-800"></div>
                <span class="text-xs text-zinc-500 uppercase tracking-wider">One-time setup</span>
                <div class="h-px flex-1 bg-zinc-800"></div>
            </div>

            <div class="space-y-8">
                <!-- Step 1: R2 bucket -->
                <div>
                    <h3 class="text-xl font-semibold mb-3 text-amber-300">
                        1. Create an R2 bucket and S3 API token
                    </h3>
                    <p class="text-zinc-300 text-sm mb-4 leading-relaxed">
                        The CLI uploads session data directly to R2 via presigned PUT URLs.
                        You must set these up <strong>before</strong> deploying the worker.
                    </p>

                    <div class="bg-zinc-900/50 border border-zinc-800 rounded-lg p-6 space-y-4">
                        <div>
                            <p class="text-zinc-400 text-xs mb-2">Create an R2 bucket in the Cloudflare dashboard:</p>
                            <div class="bg-zinc-950 rounded p-3">
                                <a href="https://dash.cloudflare.com/?to=/:account/r2/new" target="_blank" rel="noopener noreferrer" class="text-amber-400 hover:underline break-all font-mono text-sm">dash.cloudflare.com/?to=/:account/r2/new</a>
                            </div>
                        </div>

                        <div>
                            <p class="text-zinc-400 text-xs mb-2">Then create an S3 API token with read/write access to your bucket:</p>
                            <div class="bg-zinc-950 rounded p-3">
                                <a href="https://dash.cloudflare.com/?to=/:account/r2/api-tokens" target="_blank" rel="noopener noreferrer" class="text-amber-400 hover:underline break-all font-mono text-sm">dash.cloudflare.com/?to=/:account/r2/api-tokens</a>
                            </div>
                        </div>

                        <div class="bg-zinc-950 border border-zinc-800 rounded p-4">
                            <p class="text-zinc-400 text-xs mb-2">Save these values -- you will need them in step 2:</p>
                            <div class="font-mono text-sm space-y-1.5">
                                <div class="flex items-center gap-2">
                                    <span class="text-zinc-500 w-44 shrink-0">R2_ACCESS_KEY_ID</span>
                                    <span class="text-zinc-600">from the API token</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <span class="text-zinc-500 w-44 shrink-0">R2_SECRET_ACCESS_KEY</span>
                                    <span class="text-zinc-600">from the API token</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <span class="text-zinc-500 w-44 shrink-0">R2_ACCOUNT_ID</span>
                                    <span class="text-zinc-600">your Cloudflare account ID</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <span class="text-zinc-500 w-44 shrink-0">R2_BUCKET_NAME</span>
                                    <span class="text-zinc-600">the bucket you just created</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step 2: Deploy -->
                <div>
                    <h3 class="text-xl font-semibold mb-3 text-amber-300">
                        2. Deploy the Worker
                    </h3>
                    <p class="text-zinc-300 text-sm mb-4 leading-relaxed">
                        The worker stores commit metadata in D1 and serves the web UI.
                        Session data lives in R2 (set up in step 1).
                    </p>

                    <div class="bg-zinc-900/50 border border-zinc-800 rounded-lg p-6 mb-4">
                        <h4 class="font-semibold text-zinc-200 text-sm mb-3">Option A: Deploy to Cloudflare</h4>
                        <p class="text-zinc-400 text-sm leading-relaxed mb-4">
                            Click the button below to fork and deploy the worker automatically.
                            You will be prompted for secrets during the deploy process.
                        </p>

                        <div class="mb-4">
                            <a
                                href="https://deploy.workers.cloudflare.com/?url=https://github.com/butttons/residue/tree/main/packages/worker"
                                target="_blank"
                                rel="noopener noreferrer"
                                class="inline-block"
                            >
                                <img src="https://deploy.workers.cloudflare.com/button" alt="Deploy to Cloudflare Workers" />
                            </a>
                        </div>

                        <div class="bg-zinc-950 border border-zinc-800 rounded p-4">
                            <p class="text-zinc-400 text-xs mb-2">During deploy, you will be prompted for these secrets:</p>
                            <div class="font-mono text-sm space-y-1.5">
                                <div class="flex items-center gap-2">
                                    <span class="text-zinc-500 w-44 shrink-0">AUTH_TOKEN</span>
                                    <span class="text-zinc-600">generate a random string -- this is your CLI auth token</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <span class="text-zinc-500 w-44 shrink-0">R2_SECRET_ACCESS_KEY</span>
                                    <span class="text-zinc-600">from step 1</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <span class="text-zinc-500 w-44 shrink-0">ADMIN_PASSWORD</span>
                                    <span class="text-zinc-600">password for the web UI</span>
                                </div>
                            </div>
                            <p class="text-zinc-500 text-xs mt-3">
                                The R2 vars from step 1 (<code class="text-zinc-400">R2_ACCESS_KEY_ID</code>,
                                <code class="text-zinc-400">R2_ACCOUNT_ID</code>,
                                <code class="text-zinc-400">R2_BUCKET_NAME</code>) go into the worker environment variables.
                            </p>
                        </div>

                        <p class="text-zinc-500 text-xs mt-3">
                            After deploy, note your worker URL (e.g. <code class="text-zinc-400">https://residue.your-subdomain.workers.dev</code>).
                        </p>
                    </div>

                    <div class="bg-zinc-900/50 border border-zinc-800 rounded-lg p-6">
                        <h4 class="font-semibold text-zinc-200 text-sm mb-3">Option B: Manual</h4>
                        <pre class="bg-zinc-950 rounded p-3 font-mono text-xs overflow-x-auto"><code class="text-zinc-300"><span class="text-zinc-500"># Clone the repo and install dependencies</span>
git clone https://github.com/butttons/residue.git
cd residue
pnpm install
cd packages/worker

<span class="text-zinc-500"># Login to Cloudflare</span>
npx wrangler login

<span class="text-zinc-500"># Create D1 database</span>
npx wrangler d1 create residue-db
<span class="text-zinc-500"># Copy the database_id into wrangler.jsonc</span>

<span class="text-zinc-500"># Update wrangler.jsonc with:</span>
<span class="text-zinc-500">#   d1_databases[0].database_id  -> your D1 ID</span>
<span class="text-zinc-500">#   r2_buckets[0].bucket_name    -> from step 1</span>
<span class="text-zinc-500">#   R2_ACCESS_KEY_ID             -> from step 1</span>
<span class="text-zinc-500">#   R2_ACCOUNT_ID                -> from step 1</span>
<span class="text-zinc-500">#   R2_BUCKET_NAME               -> from step 1</span>
<span class="text-zinc-500">#   ADMIN_USERNAME               -> your choice</span>

<span class="text-zinc-500"># Run migrations</span>
npx wrangler d1 migrations apply residue-app --remote

<span class="text-zinc-500"># Set secrets</span>
echo "your-secret-token" | npx wrangler secret put AUTH_TOKEN
npx wrangler secret put ADMIN_PASSWORD
npx wrangler secret put R2_SECRET_ACCESS_KEY

<span class="text-zinc-500"># Deploy</span>
npx wrangler deploy</code></pre>
                    </div>
                </div>

                <!-- Step 3: AI Search -->
                <div>
                    <h3 class="text-xl font-semibold mb-3 text-amber-300">
                        3. Set up AI Search
                    </h3>
                    <p class="text-zinc-300 text-sm mb-4 leading-relaxed">
                        Search requires a Cloudflare AI Search instance connected to your R2 bucket.
                        Without this, the <code class="text-amber-300 bg-zinc-900/50 px-1.5 py-0.5 rounded">residue search</code> and
                        <code class="text-amber-300 bg-zinc-900/50 px-1.5 py-0.5 rounded">residue query</code> commands will not work.
                    </p>

                    <div class="bg-zinc-900/50 border border-zinc-800 rounded-lg p-6 space-y-4">
                        <div>
                            <p class="text-zinc-400 text-xs mb-2">Go to Compute & AI > AI Search in the Cloudflare dashboard:</p>
                            <div class="bg-zinc-950 rounded p-3">
                                <a href="https://dash.cloudflare.com/?to=/:account/ai/ai-search" target="_blank" rel="noopener noreferrer" class="text-amber-400 hover:underline break-all font-mono text-sm">dash.cloudflare.com/?to=/:account/ai/ai-search</a>
                            </div>
                        </div>

                        <ol class="text-zinc-300 text-sm space-y-2 list-decimal list-inside">
                            <li>Select <strong>Create</strong>, then <strong>Get Started</strong></li>
                            <li>Choose your R2 bucket as the data source</li>
                            <li>Leave chunking, embedding, and retrieval settings at their defaults</li>
                            <li>Name the instance <code class="text-amber-300 bg-zinc-900/50 px-1.5 py-0.5 rounded">residue-search</code></li>
                            <li>Complete the setup</li>
                        </ol>

                        <div class="bg-zinc-950 border border-zinc-800 rounded p-4">
                            <p class="text-zinc-400 text-xs mb-2">After creation, configure path filters so only search-optimized text files are indexed:</p>
                            <div class="mb-3">
                                <p class="text-zinc-500 text-xs mb-1">Go to the Settings tab of your instance:</p>
                                <a href="https://dash.cloudflare.com/?to=/:account/ai/ai-search/instance/residue-search/settings" target="_blank" rel="noopener noreferrer" class="text-amber-400 hover:underline break-all font-mono text-xs">dash.cloudflare.com/?to=/:account/ai/ai-search/instance/residue-search/settings</a>
                            </div>
                            <p class="text-zinc-400 text-xs mb-2">Under <strong>Resources > Path Filters</strong>:</p>
                            <div class="font-mono text-sm space-y-1.5">
                                <div class="flex items-center gap-2">
                                    <span class="text-zinc-500 w-24 shrink-0">Include</span>
                                    <span class="text-zinc-300">search/**</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <span class="text-zinc-500 w-24 shrink-0">Exclude</span>
                                    <span class="text-zinc-300">sessions/**</span>
                                </div>
                            </div>
                        </div>

                        <p class="text-zinc-500 text-xs">
                            For more details, see the <a href="https://developers.cloudflare.com/ai-search/get-started/dashboard/" target="_blank" rel="noopener noreferrer" class="text-amber-400 hover:underline">Cloudflare AI Search docs</a>.
                        </p>
                    </div>
                </div>

                <!-- Step 4: Install CLI -->
                <div>
                    <h3 class="text-xl font-semibold mb-3 text-amber-300">
                        4. Install the CLI
                    </h3>
                    <p class="text-zinc-400 text-sm mb-3">
                        Requires <a href="https://bun.sh" target="_blank" rel="noopener noreferrer" class="text-amber-400 hover:underline">bun</a> as the runtime. Install bun first if you don't have it.
                    </p>
                    <div class="bg-zinc-900/50 rounded-lg p-4 font-mono text-sm overflow-x-auto">
                        <div class="text-zinc-300">npm install -g @residue/cli</div>
                    </div>
                </div>

                <!-- Step 5: Login -->
                <div>
                    <h3 class="text-xl font-semibold mb-3 text-amber-300">
                        5. Login
                    </h3>
                    <div class="bg-zinc-900/50 rounded-lg p-4 font-mono text-sm overflow-x-auto mb-3">
                        <div class="text-zinc-300">residue login --url https://residue.your-subdomain.workers.dev --token YOUR_AUTH_TOKEN</div>
                    </div>
                    <div class="text-zinc-500 text-xs space-y-1">
                        <p><code class="text-zinc-400">--url</code> is your worker URL from step 2.</p>
                        <p><code class="text-zinc-400">--token</code> is the <code class="text-zinc-400">AUTH_TOKEN</code> you set in step 2.</p>
                        <p>Saves credentials to <code class="text-zinc-400">~/.residue/config</code>. One-time.</p>
                    </div>
                    <div class="bg-zinc-900/50 border border-zinc-800 rounded-lg p-4 mt-3">
                        <p class="text-zinc-400 text-xs mb-2">Use <code class="text-zinc-300">--local</code> to save credentials to <code class="text-zinc-300">.residue/config</code> in the current project instead of globally. Useful when different repos connect to different workers.</p>
                        <div class="bg-zinc-950 rounded p-3 font-mono text-sm overflow-x-auto">
                            <div class="text-zinc-300">residue login --url https://residue.your-subdomain.workers.dev --token YOUR_AUTH_TOKEN --local</div>
                        </div>
                    </div>
                </div>

                <!-- Per-project label -->
                <div class="flex items-center gap-3">
                    <div class="h-px flex-1 bg-zinc-800"></div>
                    <span class="text-xs text-zinc-500 uppercase tracking-wider">Per-project setup</span>
                    <div class="h-px flex-1 bg-zinc-800"></div>
                </div>

                <!-- Step 6: Configure repo -->
                <div>
                    <h3 class="text-xl font-semibold mb-3 text-amber-300">
                        6. Configure a repository
                    </h3>
                    <p class="text-zinc-400 text-sm mb-3">Run these in any git repository you want to track:</p>
                    <div class="bg-zinc-900/50 rounded-lg p-4 font-mono text-sm overflow-x-auto mb-4">
                        <div class="text-zinc-500"># Install git hooks (post-commit + pre-push)</div>
                        <div class="text-zinc-300">residue init</div>
                        <div class="text-zinc-300 mt-3"><span class="text-zinc-500"># Set up your agent adapter</span></div>
                        <div class="text-zinc-300">residue setup claude-code   <span class="text-zinc-500"># or: residue setup pi</span></div>
                    </div>
                    <div class="bg-zinc-900/50 border border-zinc-800 rounded-lg p-6 space-y-3">
                        <p class="text-zinc-400 text-sm">
                            <code class="text-amber-300 bg-zinc-900/50 px-1.5 py-0.5 rounded">residue init</code> --
                            Installs <code class="text-amber-300 bg-zinc-900/50 px-1.5 py-0.5 rounded">post-commit</code> and
                            <code class="text-amber-300 bg-zinc-900/50 px-1.5 py-0.5 rounded">pre-push</code> hooks.
                            Adds <code class="text-amber-300 bg-zinc-900/50 px-1.5 py-0.5 rounded">.residue/</code> to <code class="text-amber-300 bg-zinc-900/50 px-1.5 py-0.5 rounded">.gitignore</code>.
                        </p>
                        <p class="text-zinc-400 text-sm">
                            <code class="text-amber-300 bg-zinc-900/50 px-1.5 py-0.5 rounded">residue setup claude-code</code> --
                            Adds hooks to <code class="text-amber-300 bg-zinc-900/50 px-1.5 py-0.5 rounded">.claude/settings.json</code>.
                        </p>
                        <p class="text-zinc-400 text-sm">
                            <code class="text-amber-300 bg-zinc-900/50 px-1.5 py-0.5 rounded">residue setup pi</code> --
                            Installs extension at <code class="text-amber-300 bg-zinc-900/50 px-1.5 py-0.5 rounded">.pi/extensions/residue.ts</code>.
                        </p>
                        <p class="text-zinc-500 text-xs mt-1">
                            That's it. Commit and push as usual -- conversations are captured and uploaded automatically.
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- How Sessions Work -->
        <div class="mb-16">
            <h2 class="text-2xl font-bold mb-6 text-amber-400">How Sessions Work</h2>

            <div class="space-y-6">
                <div class="bg-zinc-900/50 border border-zinc-800 rounded-lg p-6">
                    <h3 class="font-semibold text-zinc-200 mb-3">Session Lifecycle</h3>
                    <ol class="text-zinc-300 text-sm space-y-2 list-decimal list-inside">
                        <li>Agent adapter calls <code class="text-amber-300 bg-zinc-900/50 px-1.5 py-0.5 rounded">residue session start</code>. CLI generates a session ID</li>
                        <li>User has a conversation with the AI agent</li>
                        <li>Agent adapter calls <code class="text-amber-300 bg-zinc-900/50 px-1.5 py-0.5 rounded">residue session end</code>. CLI marks session as ended</li>
                        <li>User commits. Post-commit hook runs <code class="text-amber-300 bg-zinc-900/50 px-1.5 py-0.5 rounded">residue capture</code>, tags pending sessions with the commit SHA</li>
                        <li>User pushes. Pre-push hook runs <code class="text-amber-300 bg-zinc-900/50 px-1.5 py-0.5 rounded">residue sync</code>, uploads session data to R2 and metadata to the worker</li>
                    </ol>
                </div>

                <div class="bg-zinc-900/50 border border-zinc-800 rounded-lg p-6">
                    <h3 class="font-semibold text-zinc-200 mb-3">Upload Flow</h3>
                    <p class="text-zinc-300 text-sm leading-relaxed mb-3">
                        Session data is uploaded <strong>directly to R2</strong> via presigned PUT URLs,
                        bypassing the worker's request body size limits entirely. A second lightweight
                        text file is uploaded alongside for search indexing. The worker only
                        receives lightweight metadata.
                    </p>
                    <pre class="bg-zinc-950 rounded p-3 font-mono text-xs overflow-x-auto"><code class="text-zinc-400">CLI
  -&gt; POST /api/sessions/upload-url <span class="text-zinc-500">(request presigned PUT URLs)</span>
  &lt;- Worker generates two presigned R2 PUT URLs
  -&gt; PUT &lt;presigned-url&gt; <span class="text-zinc-500">(upload raw data to sessions/&lt;id&gt;.json)</span>
  -&gt; PUT &lt;search-url&gt; <span class="text-zinc-500">(upload search text to search/&lt;id&gt;.txt)</span>
  -&gt; POST /api/sessions <span class="text-zinc-500">(metadata only, no session data)</span></code></pre>
                </div>

                <div class="bg-zinc-900/50 border border-zinc-800 rounded-lg p-6">
                    <h3 class="font-semibold text-zinc-200 mb-3">Multi-Commit Sessions</h3>
                    <p class="text-zinc-300 text-sm leading-relaxed">
                        A conversation can span multiple commits. If a session is still open
                        when a commit happens, it gets linked to that commit. When the next
                        commit happens, the same session gets linked again. The session data
                        is stored once in R2; multiple commits reference it.
                    </p>
                </div>

                <div class="bg-zinc-900/50 border border-zinc-800 rounded-lg p-6">
                    <h3 class="font-semibold text-zinc-200 mb-3">Open Sessions at Push Time</h3>
                    <p class="text-zinc-300 text-sm leading-relaxed">
                        If a session is still open when you push, the current state is
                        uploaded to R2. On the next push, it gets overwritten with the latest
                        state. The R2 key stays the same. Stale sessions (data file
                        unmodified for 30+ minutes) are automatically marked as ended.
                    </p>
                </div>

                <div class="bg-zinc-900/50 border border-zinc-800 rounded-lg p-6">
                    <h3 class="font-semibold text-zinc-200 mb-3">Capture Behavior</h3>
                    <p class="text-zinc-300 text-sm leading-relaxed">
                        When a commit happens, open sessions always get tagged with the SHA.
                        Ended sessions with zero commits get tagged once. Ended sessions
                        that already have commits are skipped to avoid incorrectly linking
                        unrelated work.
                    </p>
                </div>
            </div>
        </div>

        <!-- Local State -->
        <div class="mb-16">
            <h2 class="text-2xl font-bold mb-6 text-amber-400">Local State</h2>

            <div class="space-y-6">
                <div>
                    <h3 class="text-lg font-semibold mb-3 text-amber-300">Global config</h3>
                    <p class="text-zinc-400 text-sm mb-2">
                        <code class="text-amber-300 bg-zinc-900/50 px-1.5 py-0.5 rounded">~/.residue/config</code>
                    </p>
                    <pre class="bg-zinc-900/50 rounded-lg p-4 font-mono text-sm overflow-x-auto"><code class="text-zinc-300">{JSON.stringify({
                        worker_url: "https://my-residue.workers.dev",
                        token: "secret-token-from-deploy"
                    }, null, 2)}</code></pre>
                </div>

                <div>
                    <h3 class="text-lg font-semibold mb-3 text-amber-300">Pending queue</h3>
                    <p class="text-zinc-400 text-sm mb-2">
                        <code class="text-amber-300 bg-zinc-900/50 px-1.5 py-0.5 rounded">.residue/pending.json</code>
                    </p>
                    <pre class="bg-zinc-900/50 rounded-lg p-4 font-mono text-xs overflow-x-auto"><code class="text-zinc-300">{JSON.stringify([
                        {
                            id: "session-uuid-1",
                            agent: "claude-code",
                            agent_version: "1.2.3",
                            status: "ended",
                            data_path: "/path/to/raw/session/log",
                            commits: []
                        },
                        {
                            id: "session-uuid-2",
                            agent: "pi",
                            agent_version: "0.5.0",
                            status: "open",
                            data_path: "/path/to/raw/session/log",
                            commits: [{ sha: "abc123", branch: "feature-auth" }]
                        }
                    ], null, 2)}</code></pre>
                </div>

                <div>
                    <h3 class="text-lg font-semibold mb-3 text-amber-300">Hook state</h3>
                    <p class="text-zinc-400 text-sm">
                        <code class="text-amber-300 bg-zinc-900/50 px-1.5 py-0.5 rounded">.residue/hooks/</code> --
                        Maps agent session IDs to residue session IDs. Used by the Claude Code hook handler and the pi extension.
                    </p>
                </div>
            </div>
        </div>

        <!-- Worker -->
        <div class="mb-16">
            <h2 class="text-2xl font-bold mb-6 text-amber-400">Worker</h2>

            <div class="space-y-6">
                <div>
                    <h3 class="text-lg font-semibold mb-3 text-amber-300">Tech stack</h3>
                    <ul class="text-zinc-300 text-sm space-y-1">
                        <li><strong>Framework:</strong> Hono</li>
                        <li><strong>Rendering:</strong> JSX (server-rendered HTML)</li>
                        <li><strong>Storage:</strong> Cloudflare R2 (blobs, uploaded via presigned URLs) + D1 (query index)</li>
                        <li><strong>Styling:</strong> Tailwind CSS, JetBrains Mono, Phosphor Icons</li>
                    </ul>
                </div>

                <div>
                    <h3 class="text-lg font-semibold mb-3 text-amber-300">Configuration</h3>
                    <div class="space-y-4">
                        <div>
                            <p class="text-zinc-400 text-xs mb-2">Vars (in wrangler.jsonc)</p>
                            <div class="bg-zinc-900/50 rounded-lg p-4 font-mono text-xs overflow-x-auto">
                                <table class="w-full text-zinc-300">
                                    <tbody>
                                        <tr><td class="text-amber-300 pr-6 py-1">ADMIN_USERNAME</td><td class="text-zinc-400">Username for the web UI</td></tr>
                                        <tr><td class="text-amber-300 pr-6 py-1">R2_ACCESS_KEY_ID</td><td class="text-zinc-400">From R2 API Tokens page</td></tr>
                                        <tr><td class="text-amber-300 pr-6 py-1">R2_ACCOUNT_ID</td><td class="text-zinc-400">Your Cloudflare account ID</td></tr>
                                        <tr><td class="text-amber-300 pr-6 py-1">R2_BUCKET_NAME</td><td class="text-zinc-400">Name of the R2 bucket</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div>
                            <p class="text-zinc-400 text-xs mb-2">Secrets (via wrangler secret put)</p>
                            <div class="bg-zinc-900/50 rounded-lg p-4 font-mono text-xs overflow-x-auto">
                                <table class="w-full text-zinc-300">
                                    <tbody>
                                        <tr><td class="text-amber-300 pr-6 py-1">AUTH_TOKEN</td><td class="text-zinc-400">Bearer token for CLI API auth</td></tr>
                                        <tr><td class="text-amber-300 pr-6 py-1">ADMIN_PASSWORD</td><td class="text-zinc-400">Password for the web UI</td></tr>
                                        <tr><td class="text-amber-300 pr-6 py-1">R2_SECRET_ACCESS_KEY</td><td class="text-zinc-400">From R2 API Tokens page</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <div>
                    <h3 class="text-lg font-semibold mb-3 text-amber-300">API routes</h3>
                    <p class="text-zinc-400 text-xs mb-2">All routes require Authorization: Bearer &lt;token&gt;</p>
                    <div class="bg-zinc-900/50 rounded-lg p-4 font-mono text-sm space-y-2 overflow-x-auto">
                        <div>
                            <span class="text-emerald-400">POST</span>
                            <span class="text-zinc-300 ml-2">/api/sessions/upload-url</span>
                            <span class="text-zinc-500 ml-4"># presigned R2 PUT URLs (raw + search)</span>
                        </div>
                        <div>
                            <span class="text-emerald-400">POST</span>
                            <span class="text-zinc-300 ml-2">/api/sessions</span>
                            <span class="text-zinc-500 ml-4"># metadata + commit mappings</span>
                        </div>
                        <div>
                            <span class="text-amber-400">GET</span>
                            <span class="text-zinc-300 ml-3">/api/sessions/:id</span>
                            <span class="text-zinc-500 ml-4"># session data from R2</span>
                        </div>
                        <div>
                            <span class="text-amber-400">GET</span>
                            <span class="text-zinc-300 ml-3">/api/repos/:org/:repo</span>
                            <span class="text-zinc-500 ml-4"># commits with sessions</span>
                        </div>
                        <div>
                            <span class="text-amber-400">GET</span>
                            <span class="text-zinc-300 ml-3">/api/repos/:org/:repo/:sha</span>
                            <span class="text-zinc-500 ml-4"># sessions for commit</span>
                        </div>
                        <div>
                            <span class="text-amber-400">GET</span>
                            <span class="text-zinc-300 ml-3">/api/search?q=...</span>
                            <span class="text-zinc-500 ml-4"># search sessions</span>
                        </div>
                        <div>
                            <span class="text-amber-400">GET</span>
                            <span class="text-zinc-300 ml-3">/api/search/ai?q=...</span>
                            <span class="text-zinc-500 ml-4"># AI-powered search</span>
                        </div>
                    </div>
                </div>

                <div>
                    <h3 class="text-lg font-semibold mb-3 text-amber-300">UI pages</h3>
                    <p class="text-zinc-400 text-xs mb-2">Protected by Basic Auth (ADMIN_USERNAME + ADMIN_PASSWORD). Served under /app</p>
                    <div class="bg-zinc-900/50 rounded-lg p-4 font-mono text-sm space-y-2 overflow-x-auto">
                        <div>
                            <span class="text-amber-300">/app</span>
                            <span class="text-zinc-500 ml-12"># list orgs</span>
                        </div>
                        <div>
                            <span class="text-amber-300">/app/:org</span>
                            <span class="text-zinc-500 ml-8"># list repos</span>
                        </div>
                        <div>
                            <span class="text-amber-300">/app/:org/:repo</span>
                            <span class="text-zinc-500 ml-3"># commit timeline with sessions</span>
                        </div>
                        <div>
                            <span class="text-amber-300">/app/:org/:repo/:sha</span>
                            <span class="text-zinc-500 ml-2"># commit permalink + conversations</span>
                        </div>
                    </div>
                </div>

                <div>
                    <h3 class="text-lg font-semibold mb-3 text-amber-300">Conversation rendering</h3>
                    <p class="text-zinc-300 text-sm leading-relaxed mb-3">
                        Each agent gets a <strong>mapper</strong>: a pure function that transforms
                        the agent's raw session data into a common message format. The mapper
                        is the only agent-specific code. Everything else is shared.
                    </p>
                    <pre class="bg-zinc-900/50 rounded-lg p-4 font-mono text-xs overflow-x-auto"><code class="text-zinc-300">{`type ToolCall = {
  name: string;
  input: string;
  output: string;
};

type Message = {
  role: string;
  content: string;
  timestamp?: string;
  model?: string;
  tool_calls?: ToolCall[];
};

type Mapper = (raw: string) => Message[];`}</code></pre>
                    <p class="text-zinc-400 text-sm mt-3">
                        Mappers: <code class="text-amber-300 bg-zinc-900/50 px-1.5 py-0.5 rounded">claude-code.ts</code>,
                        <code class="text-amber-300 bg-zinc-900/50 px-1.5 py-0.5 rounded">pi.ts</code>.
                        Adding a new agent means writing one mapper function and registering it.
                    </p>
                </div>

                <div>
                    <h3 class="text-lg font-semibold mb-3 text-amber-300">Search</h3>
                    <p class="text-zinc-300 text-sm leading-relaxed mb-3">
                        Search is powered by <strong>Cloudflare AI Search</strong>, configured to
                        index the <code class="text-amber-300 bg-zinc-900/50 px-1.5 py-0.5 rounded">search/</code> prefix in the R2 bucket.
                        Raw session files are too large and noisy for embedding models, so the CLI
                        generates a lightweight <code class="text-amber-300 bg-zinc-900/50 px-1.5 py-0.5 rounded">.txt</code> file per session at sync time.
                    </p>
                    <p class="text-zinc-300 text-sm leading-relaxed mb-3">
                        These text files contain a metadata header (session ID, agent, commits, branch, repo)
                        followed by conversation lines tagged by role. Thinking blocks, tool output,
                        token metadata, and other noise are stripped.
                    </p>
                    <pre class="bg-zinc-950 rounded p-3 font-mono text-xs overflow-x-auto mb-3"><code class="text-zinc-400">Session: abc-123
Agent: claude-code
Commits: abc1234, def5678
Branch: feature-auth
Repo: my-team/my-app

[human] how do we fix the auth redirect
[assistant] I'll update the middleware...
[tool] edit packages/worker/src/middleware/auth.ts
[tool] bash git diff --staged</code></pre>
                    <p class="text-zinc-400 text-sm">
                        Two search endpoints are available:
                        <code class="text-amber-300 bg-zinc-900/50 px-1.5 py-0.5 rounded">GET /api/search?q=...</code> for vector search results, and
                        <code class="text-amber-300 bg-zinc-900/50 px-1.5 py-0.5 rounded">GET /api/search/ai?q=...</code> for AI-generated answers with citations.
                    </p>
                </div>
            </div>
        </div>

        <!-- D1 Schema -->
        <div class="mb-16">
            <h2 class="text-2xl font-bold mb-6 text-amber-400">Database Schema</h2>
            <pre class="bg-zinc-900/50 rounded-lg p-4 font-mono text-xs overflow-x-auto"><code class="text-zinc-300">{`CREATE TABLE sessions (
  id TEXT PRIMARY KEY,
  agent TEXT NOT NULL,
  agent_version TEXT,
  created_at INTEGER NOT NULL,
  ended_at INTEGER,
  r2_key TEXT NOT NULL
);

CREATE TABLE commits (
  commit_sha TEXT NOT NULL,
  repo TEXT NOT NULL,
  org TEXT NOT NULL,
  session_id TEXT NOT NULL,
  message TEXT,
  author TEXT,
  committed_at INTEGER,
  created_at INTEGER NOT NULL,
  branch TEXT,
  FOREIGN KEY (session_id) REFERENCES sessions(id)
);

CREATE UNIQUE INDEX idx_commits_unique
  ON commits(commit_sha, session_id);
CREATE INDEX idx_commits_repo
  ON commits(org, repo);
CREATE INDEX idx_commits_sha
  ON commits(commit_sha);
CREATE INDEX idx_commits_session
  ON commits(session_id);
CREATE INDEX idx_commits_branch
  ON commits(org, repo, branch);`}</code></pre>
        </div>

        <!-- Adapters -->
        <div class="mb-16">
            <h2 class="text-2xl font-bold mb-6 text-amber-400">Agent Adapters</h2>
            <p class="text-zinc-300 text-sm leading-relaxed mb-6">
                Adapters are built into the CLI. They hook into each agent's lifecycle
                and call <code class="text-amber-300 bg-zinc-900/50 px-1.5 py-0.5 rounded">residue session start</code> and
                <code class="text-amber-300 bg-zinc-900/50 px-1.5 py-0.5 rounded">residue session end</code> to track conversations.
                Install them with <code class="text-amber-300 bg-zinc-900/50 px-1.5 py-0.5 rounded">residue setup &lt;agent&gt;</code>.
            </p>

            <div class="space-y-6">
                <div class="bg-zinc-900/50 border border-zinc-800 rounded-lg p-6">
                    <h3 class="font-semibold text-zinc-200 mb-3">Claude Code</h3>
                    <p class="text-zinc-300 text-sm leading-relaxed mb-3">
                        Uses Claude Code's native hook system.
                        <code class="text-amber-300 bg-zinc-900/50 px-1.5 py-0.5 rounded">residue setup claude-code</code>
                        writes hook entries into <code class="text-amber-300 bg-zinc-900/50 px-1.5 py-0.5 rounded">.claude/settings.json</code>
                        that pipe session lifecycle events (as JSON on stdin) to
                        <code class="text-amber-300 bg-zinc-900/50 px-1.5 py-0.5 rounded">residue hook claude-code</code>.
                    </p>
                    <pre class="bg-zinc-950 rounded p-3 font-mono text-sm overflow-x-auto"><code class="text-zinc-300">residue setup claude-code</code></pre>
                </div>

                <div class="bg-zinc-900/50 border border-zinc-800 rounded-lg p-6">
                    <h3 class="font-semibold text-zinc-200 mb-3">pi</h3>
                    <p class="text-zinc-300 text-sm leading-relaxed mb-3">
                        Uses pi's extension system.
                        <code class="text-amber-300 bg-zinc-900/50 px-1.5 py-0.5 rounded">residue setup pi</code>
                        installs an extension at <code class="text-amber-300 bg-zinc-900/50 px-1.5 py-0.5 rounded">.pi/extensions/residue.ts</code>
                        that calls <code class="text-amber-300 bg-zinc-900/50 px-1.5 py-0.5 rounded">residue session start</code> and
                        <code class="text-amber-300 bg-zinc-900/50 px-1.5 py-0.5 rounded">residue session end</code> directly.
                    </p>
                    <pre class="bg-zinc-950 rounded p-3 font-mono text-sm overflow-x-auto"><code class="text-zinc-300">residue setup pi</code></pre>
                </div>
            </div>

            <p class="text-zinc-400 text-sm mt-4">
                Both adapters store hook state in <code class="text-amber-300 bg-zinc-900/50 px-1.5 py-0.5 rounded">.residue/hooks/</code> within the project root.
            </p>
        </div>

        <!-- Development -->
        <div class="mb-16">
            <h2 class="text-2xl font-bold mb-6 text-amber-400">Development</h2>
            <div class="bg-zinc-900/50 rounded-lg p-4 font-mono text-sm space-y-4 overflow-x-auto">
                <div>
                    <div class="text-zinc-500"># Install dependencies</div>
                    <div class="text-zinc-300">pnpm install</div>
                </div>
                <div>
                    <div class="text-zinc-500"># Dev</div>
                    <div class="text-zinc-300">pnpm --filter @residue/cli dev</div>
                    <div class="text-zinc-300">pnpm --filter @residue/worker dev</div>
                </div>
                <div>
                    <div class="text-zinc-500"># Build</div>
                    <div class="text-zinc-300">pnpm --filter @residue/cli build</div>
                </div>
                <div>
                    <div class="text-zinc-500"># Apply D1 migrations locally (required before running tests)</div>
                    <div class="text-zinc-300">cd packages/worker && pnpm exec wrangler d1 migrations apply DB --local</div>
                </div>
                <div>
                    <div class="text-zinc-500"># Run tests</div>
                    <div class="text-zinc-300">pnpm --filter @residue/worker test</div>
                </div>
            </div>
        </div>

        <!-- Contributing -->
        <div class="mb-16">
            <h2 class="text-2xl font-bold mb-6 text-amber-400">Contributing</h2>
            <p class="text-zinc-300 text-sm leading-relaxed mb-4">
                Residue is open source.
                See the <a
                    href="https://github.com/butttons/residue"
                    target="_blank"
                    rel="noopener noreferrer"
                    class="text-amber-400 hover:underline">GitHub repository</a
                > for issues, discussions, and pull requests.
            </p>
            <div class="flex gap-4">
                <a
                    href="https://github.com/butttons/residue"
                    target="_blank"
                    rel="noopener noreferrer"
                    class="bg-amber-500 hover:bg-amber-600 text-white px-4 py-2 rounded-lg font-semibold transition-colors flex items-center gap-2 text-sm"
                >
                    <Github class="w-4 h-4" />
                    View on GitHub
                </a>
            </div>
        </div>
    </div>
</Layout>
