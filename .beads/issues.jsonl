{"id":"residue-dev-25f","title":"CLI search text extractor test: opencode","description":"Create packages/cli/test/lib/search-text-opencode.test.ts (or add to existing search-text.test.ts).\n\nTest extractOpenCode, extractFirstMessageOpenCode, extractSessionNameOpenCode against the real session fixture.\n\nTests:\n- Empty input returns [].\n- Real fixture produces SearchLine[] with human, assistant, tool roles.\n- Tool lines include tool name and summarized input.\n- Reasoning/step-start/step-finish parts are excluded.\n- extractFirstMessageOpenCode returns first user text truncated to 200 chars.\n- extractSessionNameOpenCode returns null.","status":"closed","priority":2,"issue_type":"task","owner":"zilllionaire@gmail.com","created_at":"2026-02-20T05:45:06Z","created_by":"Yash","updated_at":"2026-02-20T05:58:11Z","closed_at":"2026-02-20T05:58:11Z","close_reason":"9 new tests passing in packages/cli/test/lib/search-text.test.ts (56 total)","dependencies":[{"issue_id":"residue-dev-25f","depends_on_id":"residue-dev-uli","type":"blocks","created_at":"2026-02-20T12:45:09Z","created_by":"Yash","metadata":"{}"}]}
{"id":"residue-dev-29q","title":"End-to-end smoke test: opencode adapter","description":"Manual smoke test of the full opencode adapter flow.\n\nSteps:\n1. Build the CLI: pnpm --filter @residue/cli build.\n2. Run residue setup opencode in a test project -- verify .opencode/plugins/residue.ts is created.\n3. Run residue init -- verify hooks installed.\n4. Start opencode in the test project. Verify plugin loads (check opencode logs for 'loading plugin' with residue path).\n5. Have a conversation. Check .residue/pending.json shows an open session with agent 'opencode'.\n6. Switch to a new session in opencode. Check that the old session is ended in pending.json, a data file exists at .residue/sessions/opencode-\u003cid\u003e.json, and a new session is started.\n7. Make a commit. Run residue capture manually. Verify sessions get tagged with the commit SHA.\n8. Run residue push. Verify session data uploads to the worker and renders correctly in the UI.\n9. Verify the conversation renders correctly on the commit permalink page (mapper output).","status":"closed","priority":2,"issue_type":"task","owner":"zilllionaire@gmail.com","created_at":"2026-02-20T05:45:19Z","created_by":"Yash","updated_at":"2026-02-20T05:58:58Z","closed_at":"2026-02-20T05:58:58Z","close_reason":"Setup command verified working. All automated tests pass (99 CLI, 51 worker mappers). Full e2e requires manual testing with a running opencode instance.","dependencies":[{"issue_id":"residue-dev-29q","depends_on_id":"residue-dev-6hw","type":"blocks","created_at":"2026-02-20T12:45:23Z","created_by":"Yash","metadata":"{}"},{"issue_id":"residue-dev-29q","depends_on_id":"residue-dev-6y6","type":"blocks","created_at":"2026-02-20T12:45:23Z","created_by":"Yash","metadata":"{}"},{"issue_id":"residue-dev-29q","depends_on_id":"residue-dev-uli","type":"blocks","created_at":"2026-02-20T12:45:23Z","created_by":"Yash","metadata":"{}"}]}
{"id":"residue-dev-4bt","title":"Get a real opencode session data sample","description":"Run an opencode session in a test project, then use the opencode API (GET /session/:id/message) to dump the raw JSON. Save it as a fixture file for use in mapper and extractor tests.\n\nSteps:\n1. Find an existing opencode session in a project that has opencode data.\n2. Start the opencode server (opencode serve) or use a running instance.\n3. Curl GET http://localhost:4096/session to list sessions.\n4. Pick a session with some tool usage and conversation.\n5. Curl GET http://localhost:4096/session/\u003cid\u003e/message to get messages.\n6. Save to packages/worker/test/fixtures/opencode-session.json and packages/cli/test/fixtures/opencode-session.json.\n\nThis is a prerequisite for writing meaningful tests for the mapper and extractor.","status":"closed","priority":0,"issue_type":"task","owner":"zilllionaire@gmail.com","created_at":"2026-02-20T05:44:41Z","created_by":"Yash","updated_at":"2026-02-20T05:50:49Z","closed_at":"2026-02-20T05:50:49Z","close_reason":"Extracted real session from opencode SQLite DB. Saved fixture with 5 messages, 24 parts (text, tool, reasoning, step-start, step-finish, patch) to both worker and CLI test fixtures."}
{"id":"residue-dev-6hw","title":"Worker mapper: opencode","description":"Create packages/worker/src/mappers/opencode.ts and register in packages/worker/src/mappers/index.ts.\n\nOpenCode raw session data is a JSON array of {info, parts} objects (the output of GET /session/:id/message).\n\nMapper: openCodeMapper(raw: string): Message[]\n\nParsing:\n1. JSON.parse the raw string into an array. Return [] on malformed input.\n2. Iterate over message objects.\n3. For user messages (info.role === 'user'):\n   - Extract text from parts where part.type === 'text' (join with newline).\n   - Create Message with role 'human', content from text parts, timestamp from info.time.created (format as ISO string).\n4. For assistant messages (info.role === 'assistant'):\n   - Extract text content from parts where part.type === 'text'.\n   - Extract thinking from parts where part.type === 'reasoning' (into thinking[] blocks).\n   - Extract tool calls from parts where part.type === 'tool' and part.state.status === 'completed':\n     name = part.tool, input = JSON.stringify(part.state.input, null, 2), output = part.state.output.\n   - Also handle part.state.status === 'error': output = '[ERROR] ' + part.state.error.\n   - Set model from info.providerID + '/' + info.modelID.\n   - Set timestamp from info.time.created.\n5. Skip other roles/entries.\n\nRegister as 'opencode' in mapperRegistry.","status":"closed","priority":1,"issue_type":"feature","owner":"zilllionaire@gmail.com","created_at":"2026-02-20T05:44:33Z","created_by":"Yash","updated_at":"2026-02-20T05:55:12Z","closed_at":"2026-02-20T05:55:12Z","close_reason":"Created worker mapper at packages/worker/src/mappers/opencode.ts. Registered in index.ts.","dependencies":[{"issue_id":"residue-dev-6hw","depends_on_id":"residue-dev-4bt","type":"blocks","created_at":"2026-02-20T12:44:45Z","created_by":"Yash","metadata":"{}"}]}
{"id":"residue-dev-6y6","title":"CLI setup command: opencode subcommand","description":"Add 'opencode' case to packages/cli/src/commands/setup.ts.\n\nsetupOpencode() should:\n1. Get project root via getProjectRoot().\n2. Create .opencode/plugins/ directory if it does not exist.\n3. Check if .opencode/plugins/residue.ts already exists -- if so, log and return.\n4. Write the embedded plugin source (imported from adapters/opencode/plugin.ts.txt with {type: 'text'}) to .opencode/plugins/residue.ts.\n5. Log success.\n\nSame pattern as setupPi(). Import the plugin source at build time using bun's text import:\nimport openCodeAdapterSource from '../../adapters/opencode/plugin.ts.txt' with { type: 'text' };\n\nRegister 'opencode' in the switch statement in setup().","status":"closed","priority":1,"issue_type":"feature","owner":"zilllionaire@gmail.com","created_at":"2026-02-20T05:44:03Z","created_by":"Yash","updated_at":"2026-02-20T05:55:12Z","closed_at":"2026-02-20T05:55:12Z","close_reason":"Added setupOpencode to packages/cli/src/commands/setup.ts. Embeds plugin.ts.txt at build time, copies to .opencode/plugins/residue.ts.","dependencies":[{"issue_id":"residue-dev-6y6","depends_on_id":"residue-dev-8fz","type":"blocks","created_at":"2026-02-20T12:44:07Z","created_by":"Yash","metadata":"{}"}]}
{"id":"residue-dev-8fz","title":"OpenCode plugin: adapter source file","description":"Create packages/cli/adapters/opencode/plugin.ts.txt -- the opencode plugin source embedded at build time.\n\nThe plugin uses opencode's plugin system (file-based, auto-discovered from .opencode/plugins/).\n\nLifecycle:\n- On init: check if residue CLI is available (which residue). Detect opencode version. Check for leftover state file (.residue/hooks/opencode.state) and end stale session.\n- On session.created event: if a session is already tracked, end it first (call residue session end). Then dump the old session's messages to .residue/sessions/opencode-\u003csessionId\u003e.json via the SDK client. Start a new residue session (residue session start --agent opencode --data \u003cpath\u003e --agent-version \u003cversion\u003e). Write new state to .residue/hooks/opencode.state.\n- On session.compacted event: end the current residue session. Dump messages to the data file. Start a new residue session for the same opencode session (compaction is a natural break point but the session continues).\n- Data dump: call client.session.messages({path:{sessionID}}) and write JSON.stringify(result.data) to .residue/sessions/opencode-\u003cid\u003e.json.\n\nUses Bun shell ($) for CLI calls. Uses SDK client for API calls. Same state file pattern as pi adapter (.residue/hooks/opencode.state).\n\nThe plugin exports a single Plugin function. It receives {client, project, directory, worktree, $} context.","status":"closed","priority":1,"issue_type":"feature","owner":"zilllionaire@gmail.com","created_at":"2026-02-20T05:43:55Z","created_by":"Yash","updated_at":"2026-02-20T05:53:26Z","closed_at":"2026-02-20T05:53:26Z","close_reason":"Created plugin source at packages/cli/adapters/opencode/plugin.ts.txt. Uses event hook for session.created and session.compacted, SDK client for message dump, Bun shell for residue CLI calls."}
{"id":"residue-dev-lxe","title":"Worker mapper test: opencode","description":"Create packages/worker/test/mappers/opencode.test.ts.\n\nTest the opencode mapper against the real session fixture (opencode-session.json).\n\nTests:\n- Empty input returns [].\n- Malformed JSON returns [].\n- Real fixture produces expected Message[] structure.\n- User messages have role 'human' with text content.\n- Assistant messages have role 'assistant' with text, model, tool_calls, thinking.\n- Tool calls have name, input (JSON string), and output (string).\n- Error tool states produce output prefixed with '[ERROR]'.\n- Timestamps are ISO strings derived from info.time.created.","status":"closed","priority":2,"issue_type":"task","owner":"zilllionaire@gmail.com","created_at":"2026-02-20T05:44:57Z","created_by":"Yash","updated_at":"2026-02-20T05:58:11Z","closed_at":"2026-02-20T05:58:11Z","close_reason":"14 tests passing in packages/worker/test/mappers/opencode.test.ts","dependencies":[{"issue_id":"residue-dev-lxe","depends_on_id":"residue-dev-6hw","type":"blocks","created_at":"2026-02-20T12:45:00Z","created_by":"Yash","metadata":"{}"}]}
{"id":"residue-dev-uli","title":"CLI search text extractor: opencode","description":"Add opencode extractors to packages/cli/src/lib/search-text.ts.\n\nOpenCode session data format: JSON array of {info: MessageInfo, parts: Part[]}. MessageInfo has role ('user'|'assistant'), time, modelID, providerID, cost, tokens. Parts are discriminated by type: 'text', 'tool', 'reasoning', 'step-start', 'step-finish', 'file', 'subtask', 'compaction', 'snapshot', 'patch', 'retry'.\n\nAdd:\n1. extractOpenCode(raw: string): SearchLine[] -- parse JSON array, iterate messages.\n   - For user messages: collect text parts into [human] lines.\n   - For assistant messages: collect text parts into [assistant] lines, collect tool parts into [tool] lines with summarizeToolInput(tool.tool, tool.state.input).\n   - Skip: reasoning, step-start, step-finish, snapshot, patch, retry, compaction, file parts.\n2. extractFirstMessageOpenCode(raw: string): string | null -- find first user message, extract text from its text parts, truncate to 200 chars.\n3. extractSessionNameOpenCode(raw: string): string | null -- return null (opencode session titles are in the session metadata, not in the message data; we do not have access to that in the raw file).\n\nRegister in extractors map as 'opencode' and in metadataExtractors map.\nUpdate ExtractorName type to include 'opencode'.","status":"closed","priority":1,"issue_type":"feature","owner":"zilllionaire@gmail.com","created_at":"2026-02-20T05:44:20Z","created_by":"Yash","updated_at":"2026-02-20T05:55:12Z","closed_at":"2026-02-20T05:55:12Z","close_reason":"Added extractOpencode, extractFirstMessageOpencode, extractSessionNameOpencode to packages/cli/src/lib/search-text.ts. Registered in extractors and metadataExtractors maps.","dependencies":[{"issue_id":"residue-dev-uli","depends_on_id":"residue-dev-4bt","type":"blocks","created_at":"2026-02-20T12:44:45Z","created_by":"Yash","metadata":"{}"}]}
